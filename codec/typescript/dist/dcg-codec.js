var A="DCG",f=(i=>(i[i.ja=0]="ja",i[i.en=1]="en",i[i.zh=2]="zh",i[i.ko=3]="ko",i))(f||{});function C(n){return n.reduce(function(e,r){return e+r})&255}var N=new Map(Array.from({length:36},(n,e)=>{let r=e;return e>9&&(r=e+7),[e,String.fromCharCode(48+r)]})),F=new Map(Array.from(N,n=>[n[1],n[0]])),_=class n{number;parallel_id;count;constructor(e,r,t){this.number=e,this.parallel_id=r,this.count=t}toJSON(){let e={number:this.number,"parallel-id":this.parallel_id,count:this.count};return this.parallel_id==0&&delete e["parallel-id"],e}static fromJSON(e){return e instanceof String&&(e=JSON.parse(e)),new n(e.number,e["parallel-id"]??0,e.count)}},w=class n{digi_eggs;deck;sideboard;icon;language;name;constructor(e,r,t,i,o,l){this.digi_eggs=e,this.deck=r,this.sideboard=t,this.icon=i,this.language=o,this.name=l}toJSON(){let e={"digi-eggs":this.digi_eggs.map(r=>r instanceof _?r.toJSON():r),deck:this.deck.map(r=>r instanceof _?r.toJSON():r),sideboard:this?.sideboard?.map(r=>r instanceof _?r.toJSON():r)||[],icon:this.icon,language:this.language||f[1],name:this.name};return e?.sideboard?.length==0&&delete e.sideboard,e.icon||delete e.icon,e.language||delete e.language,e}static fromJSON(e){e instanceof String&&(e=JSON.parse(e));let r=e["digi-eggs"]??[],t=e.deck??[],i=e.sideboard??[],o=e.icon??null,l=e.language??f[1];return new n(r.map(c=>_.fromJSON(c)),t.map(c=>_.fromJSON(c)),i.map(c=>_.fromJSON(c)),o,l||f[1],e.name??"")}};async function H(n){return await new Promise((e,r)=>{let t=Object.assign(new FileReader,{onload:()=>e(t.result.substr(t.result.indexOf(",")+1)),onerror:()=>r(t.error)});t.readAsDataURL(new File([n],"",{type:"application/octet-stream"}))})}function D(n,e){let r=1<<e-1,t=n&r-1;return n>=r&&(t|=r),t}function E(n,e,r){let t=e>>r-1;for(;t>0;)n.push(D(t,8)),t=t>>7}function I(n){n.sort((r,t)=>r.number.localeCompare(t.number)||r.parallel_id-t.parallel_id);let e=Object.groupBy(n,({number:r})=>{let[t,i]=r.split("-");return[t,i.length]});return Object.entries(e).map(([r,t])=>{let[i,o]=r.split(",");return[i,parseInt(o),t]})}async function P(n,e=5){let r=new Array,t=new TextEncoder,i=f[n.language]??1,o=3<=e&&e<=4?e<<4|i<<3|n.digi_eggs.length&15:e<<4|n.digi_eggs.length&15;e>=4&&n.icon&&(n.name=n.icon.padEnd(8)+n.name);let l=t.encode(n.name);l=l.slice(0,63),n.name=new TextDecoder().decode(l);let c=l.length;e>=5&&(c=i<<6|c),r.push(o),r.push(0),r.push(c);let h=r.length;if(e>=2){let u=n?.sideboard?.length??0;e>=4&&n.icon&&(u|=128),r.push(u)}let g=new Array;g=g.concat(I(n?.digi_eggs??[])),g=g.concat(I(n?.deck??[])),g=g.concat(I(n?.sideboard??[]));for(let[u,O,b]of g){if(e==0)r=r.concat(t.encode(u.padEnd(4," ")));else for(let s=0;s<u.length;s++){let m=u[s],d=F.get(m);u[parseInt(s)+1]&&(d|=128),r.push(d)}e<2?r.push(O-1<<6|b.length):(r.push(O-1<<6|D(b.length,6)),E(r,b.length,6));let y=0;for(let s of b){let m=s.number.split("-")[1],d=m-y;e==0?(r.push(s.count-1<<6|s.parallel_id<<3|D(d,3)),E(r,d,3)):(r.push(s.count-1),r.push(s.parallel_id<<5|D(d,5)),E(r,d,5)),y=m}}r[1]=C(r.slice(h));for(let u of l)r.push(u);return A+(await H(new Uint8Array(r))).replace(/\//g,"_").replace(/\+/g,"-").replace(/=/g,"")}var a=0;function T(n,e){return(n&1<<e)!=0}function J(n,e,r,t){return(n&(1<<e)-1)<<r|t}function V(n,e,r,t){if(r-1==0||T(e,r-1))for(;;){let i=t[a];if(a++,n=J(i,7,r-1,n),!T(i,7))break;r+=7}else return J(e,r-1,0,0);return n}function W(n,e,r,t,i){let o=e[a];a++;let l=n==0?(o>>6)+1:o+1;n!=0&&(o=e[a],a++);let c=n==0?o>>3&7:o>>5,h=n==0?3:5,g=J(o,h-1,0,0);return i+=V(g,o,h,e),[i,new _(r+"-"+i.toString().padStart(t,"0"),c,l)]}function Z(n){let e=new TextDecoder("utf8");a=0;let r=n[a];a++;let t=r>>4;if(!(5>=t))throw Error("Deck version "+t+" not supported");let i=3<=t&&t<=4?r&7:r&15,o=n[a];a++;let l=n[a];a++;let c=l;t>=5&&(c&=63);let h=n.slice(a,-c),g=t>=5?l>>6:r>>3&1,k=C(h);if(o!=k)throw Error("Deck checksum failed");let u=0;t>=2&&(u=n[a],a++);let O=t>=4&&u>>7>0;t>=4&&(u&=127);let b=[];for(;a<n.length-c;){let d="";if(t==0){let p=n.slice(a,a+4);a+=4,d=e.decode(p).trim()}else for(;;){let p=n[a];if(a++,d+=N.get(p&63),!(p>>7))break}let x=n[a];a++;let M=(x>>6)+1,R=x&63;t>=2&&(R=V(x,x,6,n));let U=0;for(let p=0;p<R;p++){let[X,G]=W(t,n,d,M,U);U=X,b.push(G)}}let y=null,s=e.decode(n.slice(a)).trim();if(O){let[d,x]=[s.slice(0,8),s.slice(8)];y=d.trim(),s=x.trim()}let m=new w(b.slice(0,i),b.slice(i,b.length-u),b.slice(b.length-u),y,t>=3?f[g]:null,s);return(t<2||m?.sideboard?.length==0)&&delete m.sideboard,m.icon||delete m.icon,(t<3||!m.language)&&delete m.language,m}function q(n){if(!n.startsWith(A))throw Error('Deck codes must begin with "DCG"');return Uint8Array.from(atob(n.substr(A.length).replace(/_/g,"/").replace(/-/g,"+")),e=>e.charCodeAt(0))}function z(n){return Z(q(n))}async function re(n,e=5){return await P(w.fromJSON(n),e)}function ne(n){return z(n).toJSON()}export{ne as decode,re as encode};
